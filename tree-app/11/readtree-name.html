<!DOCTYPE html>

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æœ—è¯»å…»å°æ ‘-å§“åç‰ˆ</title>
    <style>
        /* åŸæœ‰æ ·å¼å…¨éƒ¨ä¿ç•™ */
        body {
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
            background: #f4e7d3;
            text-align: center;
            padding: 20px;
            position: relative;
            transition: background 0.8s ease;
        }
        h1 {
            font-size: 28px;
            color: #2b6d2d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        .title-animation {
            display: flex;
            align-items: center;
            position: relative;
            margin-right: 15px;
        }
        .sapling-container {
            display: flex;
            gap: 5px;
            position: absolute;
            left: -80px;
        }
        .sapling {
            opacity: 0;
            transform: scale(0);
            transition: all 0.8s ease;
        }
        .big-tree {
            opacity: 0;
            transform: scale(0);
            transition: all 0.8s ease;
            position: absolute;
            left: -20px;
        }
        .info-row {
            display: flex;
            justify-content: center;
            gap: 60px;
            margin: 40px 0;
            font-size: 18px;
            color: #333;
            transform: scale(2);
            transform-origin: center;
        }
        .controls {
            margin: 20px 0;
        }
        .controls label {
            margin: 0 10px;
            font-weight: bold;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            margin: 0 5px;
        }
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 18px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background: #45a049;
        }
        #treeGrid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }
        .tree, .sapling {
            font-size: 30px;
        }
        @keyframes merge {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2) translateY(-10px); opacity: 0.5; }
            100% { transform: scale(0) translateY(20px); opacity: 0; }
        }
        @keyframes grow {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .merge-animation {
            animation: merge 0.8s ease-in-out forwards;
        }
        .grow-animation {
            animation: grow 0.5s ease-out forwards;
        }
        .floating-icons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .floating-icons button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
        }
        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: #ffffff;
            padding: 20px;
            border-left: 2px solid #ccc;
            display: none;
            box-shadow: -4px 0px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .settings-panel.active {
            display: block;
        }
        .settings-panel label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .settings-panel label span {
        width: 100px;
        text-align: left;
    }
    
    /* æ–°å¢æ ·å¼ - å­¦ç”Ÿåˆ—è¡¨å’Œæ’å */
    /* å­¦ç”Ÿåˆ—è¡¨å®¹å™¨æ ·å¼ */
    .student-list-container {
        background: #f9f9f9;
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border: 2px solid #4caf50;
    }
    
    .student-list-header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #4caf50;
    }
    
    .student-list-header h3 {
        color: #2b6d2d;
        font-size: 18px;
        margin: 0;
    }
    
    .class-container {
        display: flex;
        gap: 20px;
        margin: 0;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .group-section {
        flex: 0 0 auto;
        background: #f9f9f9;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        min-width: 280px;
        width: 280px;
    }
    
    .group-title {
        font-size: 20px;
        font-weight: bold;
        color: #2b6d2d;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .student-list {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .student-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 8px;
        background: white;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin-bottom: 4px;
    }
    
    .student-info {
        display: flex;
        align-items: center;
        gap: 6px;
        flex: 1;
    }
    
    .student-name {
        font-weight: bold;
        min-width: 60px;
        font-size: 14px;
    }
    
    .student-tree-display {
        display: flex;
        align-items: center;
        gap: 3px;
        min-height: 30px;
        padding: 3px 6px;
        background: #f0f8f0;
        border-radius: 6px;
        border: 1px solid #c8e6c9;
        min-width: 80px;
        justify-content: flex-start;
        flex-wrap: wrap;
    }
    
    .student-tree-display span {
        transition: all 0.3s ease;
        animation: grow 0.5s ease-out;
    }
    
    .tree-count {
        color: #2b6d2d;
        font-weight: bold;
        min-width: 30px;
        text-align: center;
    }
    
    .add-tree-btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        min-width: 40px;
        height: 28px;
    }
    
    .add-tree-btn:hover {
        background: #45a049;
    }
    
    .ranking-section {
        margin-top: 30px;
        background: #f9f9f9;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .ranking-title {
        font-size: 22px;
        font-weight: bold;
        color: #2b6d2d;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .ranking-list {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: white;
        border-radius: 5px;
        border: 1px solid #ddd;
    }
    
    .rank-number {
        font-weight: bold;
        color: #2b6d2d;
        min-width: 30px;
    }
    
    .top-3 {
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        border: 2px solid #ffd700;
    }
    
    .top-3 .rank-number {
        font-size: 18px;
    }
    
    .group-selector {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
    }
    
    .group-btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
    }
    
    .group-btn.active {
        background: #2b6d2d;
    }
    
    .group-btn:hover {
        background: #45a049;
    }
    
    /* æ’è¡Œæ¦œå®¹å™¨æ ·å¼ */
    .ranking-container {
        display: flex;
        gap: 20px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    
    .ranking-section {
        flex: 1;
        min-width: 300px;
        max-width: 500px;
    }
    
    /* å“åº”å¼å¸ƒå±€ */
    @media (max-width: 768px) {
        .ranking-container {
            flex-direction: column;
            gap: 15px;
        }
        
        .ranking-section {
            min-width: 100%;
            max-width: 100%;
        }
    }
    
    /* å°ç»„æ’åæ ·å¼ */
    .group-ranking {
        background: linear-gradient(135deg, #f9f9f9, #e8f5e8);
        border: 2px solid #4caf50;
    }
    
    .group-ranking .ranking-title {
        color: #1b5e20;
        font-size: 24px;
    }
    
    .group-ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-bottom: 8px;
    }
    
    .group-rank-info {
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1;
    }
    
    .group-rank-number {
        font-weight: bold;
        color: #1b5e20;
        min-width: 40px;
        font-size: 18px;
        text-align: center;
    }
    
    .group-name {
        font-weight: bold;
        font-size: 16px;
        color: #333;
        min-width: 80px;
    }
    
    .group-total-trees {
        font-weight: bold;
        color: #2b6d2d;
        font-size: 16px;
        min-width: 60px;
        text-align: center;
    }
    
    .group-avg-trees {
        font-weight: bold;
        color: #ff6b35;
        font-size: 16px;
        min-width: 60px;
        text-align: center;
    }
    
    .group-member-count {
        color: #666;
        font-size: 14px;
        min-width: 50px;
        text-align: center;
    }
    
    .group-top-3 {
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        border: 2px solid #ffd700;
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    }
    
    .group-top-3 .group-rank-number {
        font-size: 20px;
        color: #b8860b;
    }
    
    /* å…¨ç­äººå‡å°æ ‘æ ·å¼ */
    .class-avg-trees {
        margin: 10px 0 15px 0;
        text-align: center;
    }
    
    .class-avg-info {
        display: inline-block;
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border: 2px solid #2196f3;
        border-radius: 20px;
        padding: 8px 20px;
        box-shadow: 0 2px 5px rgba(33, 150, 243, 0.3);
    }
    
    .class-avg-label {
        font-weight: bold;
        color: #1976d2;
        font-size: 16px;
        margin-right: 8px;
    }
    
    .class-avg-value {
        font-weight: bold;
        color: #ff5722;
        font-size: 18px;
    }
    </style>
</head>
<body>
<h1>
    <div class="title-animation">
        <div class="sapling-container">
            <span class="sapling">ğŸŒ±</span>
            <span class="sapling">ğŸŒ±</span>
        </div>
        <span class="big-tree">ğŸŒ³</span>
    </div>
    æœ—è¯»å…»å°æ ‘-å§“åç‰ˆ
</h1>

<div class="controls" id="initialControls">
    <label>å€’è®¡æ—¶ï¼ˆç§’ï¼‰: <input type="number" id="countdownInput" value="10" min="1" /></label>
    <label>åˆ†è´é˜ˆå€¼: <input type="number" id="dbThresholdInput" value="50" min="1" /></label>
    <button onclick="resetAndStartChallenge()">å¼€å§‹æœ—è¯»æŒ‘æˆ˜</button>
</div>

<div class="info-row">
    <span>å½“å‰åˆ†è´ï¼š<span id="decibel">--</span></span>
    <span>å½“å‰å°æ ‘ï¼š<span id="score">0</span></span>
    <span>å€’è®¡æ—¶ï¼š<span id="countdown">--</span></span>
</div>

<div id="treeGrid"></div>

<!-- å°ç»„é€‰æ‹©å™¨ -->
<div class="group-selector">
    <button class="group-btn active" onclick="showGroup('all')">å…¨éƒ¨</button>
    <button class="group-btn" onclick="showGroup('group1')">ç¬¬ä¸€å°ç»„</button>
    <button class="group-btn" onclick="showGroup('group2')">ç¬¬äºŒå°ç»„</button>
    <button class="group-btn" onclick="showGroup('group3')">ç¬¬ä¸‰å°ç»„</button>
    <button class="group-btn" onclick="showGroup('group4')">ç¬¬å››å°ç»„</button>
    <button class="group-btn" onclick="showGroup('group5')">ç¬¬äº”å°ç»„</button>
    <button class="group-btn" onclick="showGroup('group6')">ç¬¬å…­å°ç»„</button>
    <button class="group-btn" onclick="showGroup('group7')">ç¬¬ä¸ƒå°ç»„</button>
    <button class="group-btn" onclick="showGroup('group8')">ç¬¬å…«å°ç»„</button>
    <button class="group-btn" onclick="showGroup('group9')">ç¬¬ä¹å°ç»„</button>
</div>

<!-- å­¦ç”Ÿåˆ—è¡¨å®¹å™¨ï¼ˆç‹¬ç«‹æ»šåŠ¨åŒºåŸŸï¼‰ -->
<div class="student-list-container">
    <div class="student-list-header">
        <h3>å­¦ç”Ÿåˆ—è¡¨ - ç‚¹å‡»"+1"æ·»åŠ å°æ ‘</h3>
    </div>
    <div class="class-container" id="classContainer">
        <!-- å­¦ç”Ÿåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>

<!-- æ’è¡Œæ¦œå®¹å™¨ -->
<div class="ranking-container">
    <!-- ä¸ªäººæ’åç³»ç»Ÿ -->
    <div class="ranking-section">
        <div class="ranking-title">&#127794; å°æ ‘æ’è¡Œæ¦œ &#127794;</div>
        <div class="class-avg-trees" id="classAvgTrees">
            <!-- å…¨ç­äººå‡å°æ ‘å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="ranking-list" id="rankingList">
            <!-- æ’åå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- å°ç»„æ’åç³»ç»Ÿ -->
    <div class="ranking-section group-ranking">
        <div class="ranking-title">&#127942; å°ç»„æ€»å°æ ‘æ’è¡Œæ¦œ &#127942;</div>
        <div class="ranking-list" id="groupRankingList">
            <!-- å°ç»„æ’åå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<div class="floating-icons" id="floatingIcons">
    <button onclick="window.location.href='index.html'">ğŸ </button>
    <button onclick="toggleSettings()">âš™ï¸</button>
    <button id="startPauseButton" class="start-button" onclick="toggleChallenge()">ğŸ®</button>
</div>

<div class="settings-panel" id="settingsPanel">
    <h2>è®¾ç½®</h2>
    <label>
        <span>å€’è®¡æ—¶ï¼ˆç§’ï¼‰:</span>
        <input type="number" id="countdownInputSettings" value="10" min="1" />
    </label>
    <label>
        <span>åˆ†è´é˜ˆå€¼:</span>
        <input type="number" id="dbThresholdInputSettings" value="50" min="1" />
    </label>
    <button onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
</div>

<script>
    // å­¦ç”Ÿæ•°æ®ç®¡ç†
    const classData = {
        group1: [
            { name: 'æ¨é”¦ç¨‹', trees: 0 },
            { name: 'é™ˆå¯é¦¨', trees: 0 },
            { name: 'åˆ˜èŠ®è¡', trees: 0 },
            { name: 'æ¨è•Šç‘œ', trees: 0 },
            { name: 'å¥šæµ©åš', trees: 0 },
            { name: 'åˆ˜å‡¡ç¦', trees: 0 }
        ],
        group2: [
            { name: 'é¾™ä¿Šæ', trees: 0 },
            { name: 'æ¨æ¾Œæ±¶', trees: 0 },
            { name: 'å½­é¦¨æ€¡', trees: 0 },
            { name: 'å¼ æ™¨è½©', trees: 0 },
            { name: 'åˆ˜å¸ˆè®¯', trees: 0 }
        ],
        group3: [
            { name: 'å”è¯—æ¶µ', trees: 0 },
            { name: 'ä»˜å­ç³', trees: 0 },
            { name: 'åˆ˜ç›ˆå¦¤', trees: 0 },
            { name: 'åˆ˜åé‚¦', trees: 0 },
            { name: 'é‚±é¹è¯š', trees: 0 },
            { name: 'å¾å­æ´‹', trees: 0 }
        ],
        group4: [
            { name: 'åˆ˜æ³“æˆ', trees: 0 },
            { name: 'æœæ€çª', trees: 0 },
            { name: 'ä¸‡å›½èŠ³', trees: 0 },
            { name: 'èƒ¡é™', trees: 0 },
            { name: 'é»„æ²›', trees: 0 },
            { name: 'é™ˆå¥•å', trees: 0 }
        ],
        group5: [
            { name: 'ç‹å®‡é£', trees: 0 },
            { name: 'å¼ ä¸½ä¸½', trees: 0 },
            { name: 'è°¢é›¨é”œ', trees: 0 },
            { name: 'ç½—å®‰é“§', trees: 0 },
            { name: 'åˆ˜å­æ¸', trees: 0 },
            { name: 'åˆ˜é¸¿è°•', trees: 0 }
        ],
        group6: [
            { name: 'å¾å¿è±ª', trees: 0 },
            { name: 'åˆ˜æ€¡å½¤', trees: 0 },
            { name: 'ç”°æµå¤•æ™', trees: 0 },
            { name: 'ç‹é“ƒçµ', trees: 0 },
            { name: 'æå“èˆª', trees: 0 },
            { name: 'æ½˜é‡ä»»', trees: 0 }
        ],
        group7: [
            { name: 'è‚–å°§', trees: 0 },
            { name: 'é™ˆå½¦æ™', trees: 0 },
            { name: 'çŸ³é¦¨', trees: 0 },
            { name: 'è°­æ¬£æ€¡', trees: 0 },
            { name: 'èµµé“­æ²›', trees: 0 },
            { name: 'é­è¾°ç†™', trees: 0 }
        ],
        group8: [
            { name: 'å½­å¯é¦¨', trees: 0 },
            { name: 'é™ˆå½©è²', trees: 0 },
            { name: 'èµµå¦æƒœ', trees: 0 },
            { name: 'æ›¾æ¶›', trees: 0 },
            { name: 'å¼ é“­æ³½', trees: 0 },
            { name: 'å¥šå´‡æ–‡', trees: 0 }
        ],
        group9: [
            { name: 'å½­å½¦ç²', trees: 0 },
            { name: 'è°­åª›å…®', trees: 0 },
            { name: 'ææ€é¢–', trees: 0 },
            { name: 'é¾šè¯—ç‘', trees: 0 },
            { name: 'é™ˆæ¯…', trees: 0 },
            { name: 'åˆ˜å˜‰éº’', trees: 0 }
        ]
    };
    
    let currentGroup = 'all';
    
    // åˆå§‹åŒ–å­¦ç”Ÿåˆ—è¡¨
    function initStudentList() {
        // åˆå§‹åŒ–æ‰€æœ‰å­¦ç”Ÿçš„å±æ€§ï¼Œé»˜è®¤ä¸æ˜¾ç¤ºæ ‘è‹—
        Object.keys(classData).forEach(groupId => {
            classData[groupId].forEach(student => {
                if (!student.hasOwnProperty('saplings')) {
                    student.saplings = 0; // é»˜è®¤æ²¡æœ‰æ ‘è‹—
                }
                if (!student.hasOwnProperty('initialSaplingUsed')) {
                    student.initialSaplingUsed = true; // æ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼Œä¸æ˜¾ç¤ºæ°´æ»´æŒ‰é’®
                }
            });
        });
        
        renderStudentList();
        updateRanking();
    }
    
    // æ¸²æŸ“å­¦ç”Ÿåˆ—è¡¨
    function renderStudentList() {
        const container = document.getElementById('classContainer');
        container.innerHTML = '';
        
        if (currentGroup === 'all') {
            // æ˜¾ç¤ºæ‰€æœ‰å°ç»„
            Object.keys(classData).forEach(groupId => {
                const groupSection = createGroupSection(groupId, classData[groupId]);
                container.appendChild(groupSection);
            });
        } else {
            // æ˜¾ç¤ºæŒ‡å®šå°ç»„
            const groupSection = createGroupSection(currentGroup, classData[currentGroup]);
            container.appendChild(groupSection);
        }
    }
    
    // åˆ›å»ºå°ç»„åŒºåŸŸ
    function createGroupSection(groupId, students) {
        const section = document.createElement('div');
        section.className = 'group-section';
        
        const title = document.createElement('div');
        title.className = 'group-title';
        title.textContent = getGroupName(groupId);
        
        const list = document.createElement('div');
        list.className = 'student-list';
        
        students.forEach((student, index) => {
            const studentItem = createStudentItem(student, groupId, index);
            list.appendChild(studentItem);
        });
        
        section.appendChild(title);
        section.appendChild(list);
        return section;
    }
    
    // åˆ›å»ºå­¦ç”Ÿé¡¹ç›®
    function createStudentItem(student, groupId, index) {
        const item = document.createElement('div');
        item.className = 'student-item';
        item.setAttribute('data-group', groupId);
        item.setAttribute('data-index', index);
        
        const info = document.createElement('div');
        info.className = 'student-info';
        
        const name = document.createElement('span');
        name.className = 'student-name';
        name.textContent = student.name;
        
        const treeCount = document.createElement('div');
        treeCount.className = 'student-tree-display';
        treeCount.style.cssText = `
            display: flex;
            align-items: center;
            gap: 5px;
            min-height: 40px;
        `;
        
        // æ˜¾ç¤ºæ ‘çš„å›¾æ ‡ï¼ˆé»˜è®¤ä¸æ˜¾ç¤ºï¼Œåªæœ‰ç‚¹å‡»+1åæ‰ä¼šæ˜¾ç¤ºï¼‰
        for (let i = 0; i < student.trees; i++) {
            const treeIcon = document.createElement('span');
            treeIcon.textContent = 'ğŸŒ³';
            treeIcon.style.cssText = `
                font-size: 20px;
                transition: all 0.3s ease;
            `;
            treeCount.appendChild(treeIcon);
        }
        
        // å¦‚æœæ²¡æœ‰æ ‘ï¼Œæ˜¾ç¤ºç©ºç™½åŒºåŸŸ
        if (student.trees === 0) {
            const emptySpace = document.createElement('span');
            emptySpace.textContent = '';
            emptySpace.style.cssText = `
                min-width: 20px;
                min-height: 20px;
                display: inline-block;
            `;
            treeCount.appendChild(emptySpace);
        }
        
        // ä¸æ˜¾ç¤ºæ ‘è‹—å›¾æ ‡ï¼Œåªæ˜¾ç¤ºæ ‘æœ¨
        
        const addButton = document.createElement('button');
        addButton.className = 'add-tree-btn';
        
        // ç»Ÿä¸€æ˜¾ç¤º+1æŒ‰é’®ï¼Œç‚¹å‡»åç›´æ¥æ·»åŠ å°æ ‘
        addButton.textContent = '+1';
        addButton.title = 'æ·»åŠ ä¸€æ£µå°æ ‘';
        addButton.onclick = () => addTreeToStudent(groupId, index);
        
        info.appendChild(name);
        info.appendChild(treeCount);
        item.appendChild(info);
        item.appendChild(addButton);
        
        return item;
    }
    
    // ç§»é™¤æµ‡æ°´åŠŸèƒ½ï¼Œç»Ÿä¸€ä½¿ç”¨æ·»åŠ å°æ ‘åŠŸèƒ½
    
    // æ›´æ–°å•ä¸ªå­¦ç”Ÿçš„æ˜¾ç¤º
    function updateStudentItem(groupId, studentIndex) {
        const student = classData[groupId][studentIndex];
        const container = document.querySelector('.student-list-container');
        const existingItem = container.querySelector(`[data-group="${groupId}"][data-index="${studentIndex}"]`);
        
        if (existingItem) {
            const newItem = createStudentItem(student, groupId, studentIndex);
            newItem.setAttribute('data-group', groupId);
            newItem.setAttribute('data-index', studentIndex);
            existingItem.parentNode.replaceChild(newItem, existingItem);
        }
    }
    
    // ä¸ºæŒ‡å®šå­¦ç”Ÿæ·»åŠ å°æ ‘
    function addTreeToStudent(groupId, studentIndex) {
        const student = classData[groupId][studentIndex];
        
        // ç›´æ¥æ·»åŠ ä¸€æ£µå°æ ‘
        student.trees++;
        
        // æ˜¾ç¤ºæ ‘æ·»åŠ åŠ¨ç”»ï¼ˆæ˜¾ç¤ºæ ‘æœ¨å›¾æ ‡ï¼‰
        showTreeAddedAnimation(student.name, true);
        
        // åªæ›´æ–°å½“å‰å­¦ç”Ÿçš„æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯åˆ·æ–°æ•´ä¸ªåˆ—è¡¨
        updateStudentItem(groupId, studentIndex);
        updateRanking();
        
        // ä¿å­˜æ•°æ®åˆ°localStorage
        saveClassData();
    }
    
    // æ˜¾ç¤ºå°æ ‘æ·»åŠ åŠ¨ç”»
    function showTreeAddedAnimation(studentName, isTree = false) {
        const animation = document.createElement('div');
        animation.className = 'sapling grow-animation';
        animation.textContent = isTree ? 'ğŸŒ³' : 'ğŸŒ±';
        animation.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 48px;
            z-index: 1000;
            opacity: 0;
        `;
        
        document.body.appendChild(animation);
        
        // ç”Ÿé•¿åŠ¨ç”»
        setTimeout(() => {
            animation.style.opacity = '1';
            animation.style.transform = 'translate(-50%, -50%) scale(1)';
        }, 100);
        
        // æ˜¾ç¤ºå­¦ç”Ÿåå­—
        const nameLabel = document.createElement('div');
        nameLabel.textContent = `${studentName} +1`;
        nameLabel.style.cssText = `
            position: fixed;
            top: calc(50% + 40px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1001;
            opacity: 0;
        `;
        document.body.appendChild(nameLabel);
        
        // åå­—æ·¡å…¥
        setTimeout(() => {
            nameLabel.style.opacity = '1';
        }, 300);
        
        // æ·¡å‡ºåŠ¨ç”»
        setTimeout(() => {
            animation.style.opacity = '0';
            animation.style.transform = 'translate(-50%, -50%) scale(0.5)';
            nameLabel.style.opacity = '0';
        }, 1500);
        
        // ç§»é™¤å…ƒç´ 
        setTimeout(() => {
            animation.remove();
            nameLabel.remove();
        }, 2000);
    }
    
    // æ›´æ–°æ’å
    function updateRanking() {
        const rankingList = document.getElementById('rankingList');
        rankingList.innerHTML = '';
        
        // è·å–æ‰€æœ‰å­¦ç”Ÿå¹¶æŒ‰å°æ ‘æ•°é‡æ’åº
        const allStudents = [];
        Object.keys(classData).forEach(groupId => {
            classData[groupId].forEach(student => {
                allStudents.push({
                    ...student,
                    group: groupId
                });
            });
        });
        
        allStudents.sort((a, b) => b.trees - a.trees);
        
        // æ˜¾ç¤ºå‰10å
        allStudents.slice(0, 10).forEach((student, index) => {
            const rankItem = createRankItem(student, index + 1);
            rankingList.appendChild(rankItem);
        });
        
        // æ›´æ–°å°ç»„æ’å
        updateGroupRanking();
        
        // æ›´æ–°å…¨ç­äººå‡å°æ ‘
        updateClassAvgTrees();
    }
    
    // æ›´æ–°å…¨ç­äººå‡å°æ ‘
    function updateClassAvgTrees() {
        const classAvgElement = document.getElementById('classAvgTrees');
        
        // è®¡ç®—å…¨ç­æ€»å°æ ‘å’Œæ€»äººæ•°
        let totalClassTrees = 0;
        let totalClassMembers = 0;
        
        Object.keys(classData).forEach(groupId => {
            const groupTrees = classData[groupId].reduce((sum, student) => sum + student.trees, 0);
            const groupMembers = classData[groupId].length;
            totalClassTrees += groupTrees;
            totalClassMembers += groupMembers;
        });
        
        // è®¡ç®—å…¨ç­äººå‡å°æ ‘
        const classAvgTrees = totalClassMembers > 0 ? (totalClassTrees / totalClassMembers).toFixed(1) : 0;
        
        // æ›´æ–°æ˜¾ç¤º
        classAvgElement.innerHTML = `
            <div class="class-avg-info">
                <span class="class-avg-label">å…¨ç­äººå‡å°æ ‘ï¼š</span>
                <span class="class-avg-value">${classAvgTrees} ğŸŒ³</span>
            </div>
        `;
    }
    
    // æ›´æ–°å°ç»„æ’å
    function updateGroupRanking() {
        const groupRankingList = document.getElementById('groupRankingList');
        groupRankingList.innerHTML = '';
        
        // è®¡ç®—æ¯ä¸ªå°ç»„çš„æ€»å°æ ‘æ•°é‡å’Œäººå‡å°æ ‘
        const groupStats = [];
        Object.keys(classData).forEach(groupId => {
            const totalTrees = classData[groupId].reduce((sum, student) => sum + student.trees, 0);
            const memberCount = classData[groupId].length;
            const avgTrees = memberCount > 0 ? (totalTrees / memberCount).toFixed(1) : 0;
            groupStats.push({
                groupId: groupId,
                groupName: getGroupName(groupId),
                totalTrees: totalTrees,
                memberCount: memberCount,
                avgTrees: avgTrees
            });
        });
        
        // æŒ‰äººå‡å°æ ‘æ•°é‡æ’åº
        groupStats.sort((a, b) => b.avgTrees - a.avgTrees);
        
        // æ˜¾ç¤ºæ‰€æœ‰å°ç»„æ’å
        groupStats.forEach((group, index) => {
            const groupRankItem = createGroupRankItem(group, index + 1);
            groupRankingList.appendChild(groupRankItem);
        });
    }
    
    // åˆ›å»ºå°ç»„æ’åé¡¹ç›®
    function createGroupRankItem(group, rank) {
        const item = document.createElement('div');
        item.className = 'group-ranking-item';
        if (rank <= 3) {
            item.classList.add('group-top-3');
        }
        
        const rankInfo = document.createElement('div');
        rankInfo.className = 'group-rank-info';
        
        const rankNumber = document.createElement('span');
        rankNumber.className = 'group-rank-number';
        rankNumber.textContent = `ç¬¬${rank}å`;
        
        const groupName = document.createElement('span');
        groupName.className = 'group-name';
        groupName.textContent = group.groupName;
        
        const totalTrees = document.createElement('span');
        totalTrees.className = 'group-total-trees';
        totalTrees.textContent = `ğŸŒ³ ${group.totalTrees}`;
        
        const avgTrees = document.createElement('span');
        avgTrees.className = 'group-avg-trees';
        avgTrees.textContent = `ğŸ‘¤ ${group.avgTrees}`;
        
        const memberCount = document.createElement('span');
        memberCount.className = 'group-member-count';
        memberCount.textContent = `ğŸ‘¥ ${group.memberCount}äºº`;
        
        rankInfo.appendChild(rankNumber);
        rankInfo.appendChild(groupName);
        rankInfo.appendChild(totalTrees);
        rankInfo.appendChild(avgTrees);
        rankInfo.appendChild(memberCount);
        item.appendChild(rankInfo);
        
        return item;
    }
    
    // åˆ›å»ºæ’åé¡¹ç›®
    function createRankItem(student, rank) {
        const item = document.createElement('div');
        item.className = 'ranking-item';
        if (rank <= 3) {
            item.classList.add('top-3');
        }
        
        const rankInfo = document.createElement('div');
        rankInfo.className = 'student-info';
        
        const rankNumber = document.createElement('span');
        rankNumber.className = 'rank-number';
        rankNumber.textContent = `ç¬¬${rank}å`;
        
        const name = document.createElement('span');
        name.className = 'student-name';
        name.textContent = `${student.name} (${getGroupName(student.group)})`;
        
        const treeCount = document.createElement('span');
        treeCount.className = 'tree-count';
        treeCount.textContent = `ğŸŒ³ ${student.trees}`;
        
        rankInfo.appendChild(rankNumber);
        rankInfo.appendChild(name);
        rankInfo.appendChild(treeCount);
        item.appendChild(rankInfo);
        
        return item;
    }
    
    // æ˜¾ç¤ºæŒ‡å®šå°ç»„
    function showGroup(groupId) {
        currentGroup = groupId;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.group-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        renderStudentList();
    }
    
    // è·å–å°ç»„åç§°
    function getGroupName(groupId) {
        const groupNames = {
            group1: 'ç¬¬ä¸€å°ç»„',
            group2: 'ç¬¬äºŒå°ç»„',
            group3: 'ç¬¬ä¸‰å°ç»„',
            group4: 'ç¬¬å››å°ç»„',
            group5: 'ç¬¬äº”å°ç»„',
            group6: 'ç¬¬å…­å°ç»„',
            group7: 'ç¬¬ä¸ƒå°ç»„',
            group8: 'ç¬¬å…«å°ç»„',
            group9: 'ç¬¬ä¹å°ç»„'
        };
        return groupNames[groupId] || groupId;
    }
    
    // æ·»åŠ æ·¡å‡ºåŠ¨ç”»æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeUp {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -100%) scale(0.8); }
        }
    `;
    document.head.appendChild(style);
    
    document.addEventListener('DOMContentLoaded', () => {
        // åˆå§‹åŒ–å­¦ç”Ÿåˆ—è¡¨å’Œæ’å
        initStudentList();
        
        const saplings = document.querySelectorAll('.sapling');
        const bigTree = document.querySelector('.big-tree');

        setTimeout(() => {
            saplings.forEach((s, index) => {
                s.style.opacity = '1';
                s.style.transform = 'scale(1)';
                s.style.transitionDelay = `${index * 0.2}s`;
            });
        }, 500);

        setTimeout(() => {
            saplings.forEach(s => {
                s.style.opacity = '0';
                s.style.transform = 'scale(0)';
            });
            bigTree.style.opacity = '1';
            bigTree.style.transform = 'scale(1)';
        }, 2000);
    });

    function updateBackground(score) {
        const baseHue = 38;
        const maxHue = 100;
        const baseSaturation = 55;
        const maxSaturation = 70;
        const baseLightness = 88;
        const minLightness = 78;

        const progress = Math.min(score / 10, 10);
        const currentHue = baseHue + (maxHue - baseHue) * Math.pow(progress / 10, 0.9);
        const currentSaturation = baseSaturation + (maxSaturation - baseSaturation) * Math.pow(progress / 10, 0.8);
        const currentLightness = baseLightness - (baseLightness - minLightness) * Math.pow(progress / 10, 1.2);

        document.body.style.backgroundColor = `hsl(${currentHue}, ${currentSaturation}%, ${currentLightness}%)`;
    }

    let audioContext, analyser, microphone, javascriptNode;
    let isLoud = false;
    let isRunning = false;
    let countdownTimer = null;
    let score = 0;
    let saplingCount = 0;

    const dbDisplay = document.getElementById('decibel');
    const scoreDisplay = document.getElementById('score');
    const countdownDisplay = document.getElementById('countdown');
    const treeGrid = document.getElementById('treeGrid');
    const settingsPanel = document.getElementById('settingsPanel');
    const floatingIcons = document.getElementById('floatingIcons');
    const startPauseButton = document.getElementById('startPauseButton');
    const initialControls = document.getElementById('initialControls');

    function toggleSettings() {
        document.getElementById('countdownInputSettings').value = document.getElementById('countdownInput').value;
        document.getElementById('dbThresholdInputSettings').value = document.getElementById('dbThresholdInput').value;
        settingsPanel.classList.toggle('active');
    }

    function saveSettings() {
        countdownSeconds = parseInt(document.getElementById('countdownInputSettings').value) || 10;
        dbThreshold = parseInt(document.getElementById('dbThresholdInputSettings').value) || 50;
        document.getElementById('countdownInput').value = countdownSeconds;
        document.getElementById('dbThresholdInput').value = dbThreshold;
        settingsPanel.classList.remove('active');
    }

    function resetAndStartChallenge() {
        score = 0;
        saplingCount = 0;
        treeGrid.innerHTML = "";
        scoreDisplay.textContent = score;
        document.body.style.backgroundColor = '#f4e7d3';
        startChallenge();
    }

    function toggleChallenge() {
        isRunning ? pauseChallenge() : startChallenge();
    }

    function startChallenge() {
        countdownSeconds = parseInt(document.getElementById('countdownInput').value) || 10;
        dbThreshold = parseInt(document.getElementById('dbThresholdInput').value) || 50;

        if (isRunning) return;
        isRunning = true;

        initialControls.style.display = 'none';

        startMicrophone();
        startCountdownCycle();

        startPauseButton.textContent = 'â¸ï¸';
        startPauseButton.classList.add('active');
    }

    function pauseChallenge() {
        isRunning = false;
        clearInterval(countdownTimer);
        countdownDisplay.textContent = "--";
        stopMicrophone();

        startPauseButton.textContent = 'ğŸ®';
        startPauseButton.classList.remove('active');
    }

    function startCountdownCycle() {
        if (!isRunning) return;
        remainingTime = countdownSeconds;
        updateCountdownUI();

        clearInterval(countdownTimer);
        countdownTimer = setInterval(() => {
            if (!isRunning) return;

            if (!isLoud) {
                countdownDisplay.textContent = `å£°éŸ³ä¸å¤Ÿå¤§ï¼Œè¯·å¤§å£°æœ—è¯»... (${remainingTime}s)`;
                return;
            }

            remainingTime--;
            updateCountdownUI();

            if (remainingTime <= 0) {
                clearInterval(countdownTimer);
                growSapling();
                setTimeout(startCountdownCycle, 1000);
            }
        }, 1000);
    }

    function updateCountdownUI() {
        countdownDisplay.textContent = `${remainingTime} ç§’`;
    }

    function growSapling() {
        const sapling = document.createElement('div');
        sapling.className = 'sapling grow-animation';
        sapling.textContent = 'ğŸŒ±';
        treeGrid.appendChild(sapling);
        saplingCount++;

        if (saplingCount >= 2) {
            const saplings = treeGrid.querySelectorAll('.sapling');
            if (saplings.length >= 2) {
                saplings[0].classList.add('merge-animation');
                saplings[1].classList.add('merge-animation');

                setTimeout(() => {
                    saplings[0].remove();
                    saplings[1].remove();
                    saplingCount -= 2;

                    const tree = document.createElement('div');
                    tree.className = 'tree grow-animation';
                    tree.textContent = 'ğŸŒ³';
                    treeGrid.appendChild(tree);
                    score++;
                    scoreDisplay.textContent = score;

                    if (score % 10 === 0) {
                        updateBackground(score);
                    }
                }, 800);
            }
        }
    }

    function startMicrophone() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

            analyser.smoothingTimeConstant = 0.8;
            analyser.fftSize = 1024;

            microphone.connect(analyser);
            analyser.connect(javascriptNode);
            javascriptNode.connect(audioContext.destination);

            javascriptNode.onaudioprocess = function () {
                const array = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(array);
                const average = array.reduce((a, b) => a + b) / array.length;
                const db = Math.round(average);
                dbDisplay.textContent = db;
                isLoud = db >= dbThreshold;
            };
        }).catch(err => {
            alert("éº¦å…‹é£å¯åŠ¨å¤±è´¥ï¼š" + err.message);
        });
    }

    function stopMicrophone() {
        if (microphone?.mediaStream) {
            microphone.mediaStream.getTracks().forEach(track => track.stop());
        }
        if (audioContext) {
            audioContext.close();
        }
    }
</script>
</body>
</html>