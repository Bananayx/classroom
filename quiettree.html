
<!DOCTYPE html>

<!--
  ç‰ˆæƒæ‰€æœ‰ Â© 2025 å–µå–µå–µå–µè€å¸ˆ ä¿ç•™æ‰€æœ‰æƒåˆ©
  ç‹¬ç«‹ç”¨æˆ·ä¸“å±æˆæƒåè®® - åŸåˆ›ä½œå“ç‰ˆæƒè¯´æ˜

  ã€è‘—ä½œæƒä¸çŸ¥è¯†äº§æƒå£°æ˜ã€‘
  æœ¬ç³»ç»Ÿï¼ˆåŒ…æ‹¬ä½†ä¸é™äºï¼šæºä»£ç ã€æ ·å¼æ–‡ä»¶ã€ç•Œé¢è®¾è®¡ã€å›¾å½¢å…ƒç´ ã€äº¤äº’é€»è¾‘ç­‰ï¼‰ç”±ã€å–µå–µå–µå–µè€å¸ˆã€‘åŸåˆ›å¼€å‘ï¼Œ
  å±äºåŸåˆ›è½¯ä»¶ä½œå“ï¼Œä¾æ³•äº«æœ‰å®Œæ•´çŸ¥è¯†äº§æƒï¼Œå—ã€Šä¸­åäººæ°‘å…±å’Œå›½è‘—ä½œæƒæ³•ã€‹åŠç›¸å…³å›½é™…ç‰ˆæƒå…¬çº¦ä¿æŠ¤ã€‚
  æœªç»è‘—ä½œæƒäººä¹¦é¢æˆæƒï¼Œä»»ä½•ä¸ªäººæˆ–ç»„ç»‡ä¸å¾—ä»¥ä»»ä½•å½¢å¼å¤åˆ¶ã€ä¼ æ’­ã€å‡ºå”®ã€ç¯¡æ”¹ã€é€†å‘å·¥ç¨‹æˆ–å…¬å¼€å‘å¸ƒæœ¬ç³»ç»Ÿå†…å®¹ã€‚

  ã€æˆæƒä½¿ç”¨èŒƒå›´ã€‘
  æœ¬ç³»ç»Ÿä¸ºå•ä¸€ç”¨æˆ·æˆæƒç‰ˆæœ¬ï¼Œä»…é™è´­ä¹°è€…æœ¬äººåœ¨æˆæƒç»ˆç«¯è®¾å¤‡ä¸Šä¸ªäººä½¿ç”¨ï¼Œä¸¥ç¦ä¸‹åˆ—è¡Œä¸ºï¼š
  - å‘ä»–äººä¼ æ’­ã€åˆ†äº«ã€è½¬å”®ã€å…¬å¼€å‘å¸ƒæœ¬ç³»ç»Ÿæºä»£ç ã€æ‰“åŒ…æ–‡ä»¶æˆ–å…¶è¡ç”Ÿç‰ˆæœ¬ï¼›
  - å°†æœ¬ç³»ç»Ÿæˆ–å…¶éƒ¨åˆ†å†…å®¹ç”¨äºä»»ä½•å•†ä¸šç›®çš„ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šå•†ä¸šé¡¹ç›®ã€å•†ä¸šæ¼”ç¤ºã€çŸ¥è¯†ä»˜è´¹è¯¾ç¨‹ã€åŸ¹è®­ç­æˆ–ä¼ä¸šå†…éƒ¨ä½¿ç”¨ï¼›
  - åœ¨ç¤¾äº¤åª’ä½“å¹³å°ï¼ˆå¦‚ï¼šå°çº¢ä¹¦ã€æŠ–éŸ³ã€å¾®åšã€Bç«™ç­‰ï¼‰å‘å¸ƒæ¼”ç¤ºã€æˆªå›¾ã€è§†é¢‘ç­‰å†…å®¹ç”¨äºå¼•æµã€å˜ç›¸å®£ä¼ æˆ–å•†ä¸šæ¨å¹¿ï¼›
  - åˆ é™¤æˆ–ä¿®æ”¹æœ¬ç‰ˆæƒå£°æ˜ä¸æˆæƒéªŒè¯æœºåˆ¶ï¼›
  - ä»¥â€œå‚è€ƒä½œå“â€â€œå€Ÿé‰´æ€è·¯â€ç­‰å½¢å¼ï¼Œåˆ¶ä½œæˆ–ä¼ æ’­ä»»ä½•é£æ ¼ã€åŠŸèƒ½ç›¸ä¼¼çš„å˜ä½“ä½œå“ã€‚

  ã€è§†è§‰å‘ˆç°ä¸ç•Œé¢è®¾è®¡æƒå±ã€‘
  æœ¬ç³»ç»Ÿæ‰€åŒ…å«çš„ç•Œé¢å¸ƒå±€ã€è§†è§‰é£æ ¼ã€æ°´å°æ ·å¼ã€åŠ¨ç”»é€»è¾‘åŠå›¾å½¢æ’ç‰ˆï¼Œå‡ä¸ºåŸåˆ›è®¾è®¡æˆæœï¼Œ
  å—ã€Šè‘—ä½œæƒæ³•ã€‹åŠã€Šåä¸æ­£å½“ç«äº‰æ³•ã€‹ç­‰æ³•å¾‹æ³•è§„ä¿æŠ¤ï¼Œä»»ä½•æŠ„è¢­ã€ä»¿åˆ¶ã€æ”¹ç¼–ã€ç§»æ¤æˆ–å•†ç”¨æ¼”ç»å‡å±è¿æ³•è¡Œä¸ºã€‚

  ã€æ³•å¾‹è´£ä»»æç¤ºã€‘
  è‘—ä½œæƒäººä¿ç•™ä¾æ³•è¿½ç©¶ä¾µæƒã€è¿çº¦ç­‰è¿æ³•è¡Œä¸ºçš„ä¸€åˆ‡æ³•å¾‹æƒåˆ©ï¼Œè¿è§„ä½¿ç”¨å°†é¢ä¸´æ°‘äº‹èµ”å¿ã€å°ç¦æœåŠ¡ã€
  ä¸¥é‡è€…ä¾æ³•ç§»äº¤å¸æ³•æœºå…³å¤„ç†ã€‚

  -----------------------------------------------------------------------
  âš  ä½¿ç”¨æœ¬ç³»ç»Ÿå³è¡¨ç¤ºæ‚¨å·²å……åˆ†é˜…è¯»ã€ç†è§£å¹¶åŒæ„ä»¥ä¸Šå…¨éƒ¨æ¡æ¬¾ã€‚
-->

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®‰é™å…»å°æ ‘</title>
    <style>
        /* åŸæœ‰æ ·å¼å…¨éƒ¨ä¿ç•™ */
        body {
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
            background: #f4e7d3;
            text-align: center;
            padding: 20px;
            position: relative;
            transition: background 0.8s ease;
        }
        h1 {
            font-size: 28px;
            color: #2b6d2d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        .title-animation {
            display: flex;
            align-items: center;
            position: relative;
            margin-right: 15px;
        }
        .sapling-container {
            display: flex;
            gap: 5px;
            position: absolute;
            left: -80px;
        }
        .sapling {
            opacity: 0;
            transform: scale(0);
            transition: all 0.8s ease;
        }
        .big-tree {
            opacity: 0;
            transform: scale(0);
            transition: all 0.8s ease;
            position: absolute;
            left: -20px;
        }
        .info-row {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            font-size: 18px;
            color: #333;
        }
        .controls {
            margin: 20px 0;
        }
        .controls label {
            margin: 0 10px;
            font-weight: bold;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            margin: 0 5px;
        }
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 18px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background: #45a049;
        }
        #treeGrid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }
        .tree, .sapling {
            font-size: 30px;
        }
        @keyframes merge {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2) translateY(-10px); opacity: 0.5; }
            100% { transform: scale(0) translateY(20px); opacity: 0; }
        }
        @keyframes grow {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .merge-animation {
            animation: merge 0.8s ease-in-out forwards;
        }
        .grow-animation {
            animation: grow 0.5s ease-out forwards;
        }
        .floating-icons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: none;
            flex-direction: column;
            gap: 10px;
        }
        .floating-icons button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
        }
        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: #ffffff;
            padding: 20px;
            border-left: 2px solid #ccc;
            display: none;
            box-shadow: -4px 0px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        .settings-panel.active {
            display: block;
        }
        .settings-panel label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .settings-panel label span {
            width: 100px;
            text-align: left;
        }
    </style>
</head>
<body>
<h1>
    <div class="title-animation">
        <div class="sapling-container">
            <span class="sapling">ğŸŒ±</span>
            <span class="sapling">ğŸŒ±</span>
        </div>
        <span class="big-tree">ğŸŒ³</span>
    </div>
    å®‰é™å…»å°æ ‘
</h1>

<div class="controls" id="initialControls">
    <label>å®‰é™æ—¶é—´ï¼ˆç§’ï¼‰: <input type="number" id="countdownInput" value="30" min="1" /></label>
    <label>å®‰é™é˜ˆå€¼ï¼ˆåˆ†è´ï¼‰: <input type="number" id="dbThresholdInput" value="35" min="1" /></label>
    <button onclick="resetAndStartChallenge()">å¼€å§‹å®‰é™æŒ‘æˆ˜</button>
</div>

<div class="info-row">
    <span>å½“å‰åˆ†è´ï¼š<span id="decibel">--</span></span>
    <span>å½“å‰å°æ ‘ï¼š<span id="score">0</span></span>
    <span>å€’è®¡æ—¶ï¼š<span id="countdown">--</span></span>
</div>

<div id="treeGrid"></div>

<div class="floating-icons" id="floatingIcons">
    <button onclick="toggleSettings()">âš™ï¸</button>
    <button id="startPauseButton" class="start-button" onclick="toggleChallenge()">ğŸ®</button>
</div>

<div class="settings-panel" id="settingsPanel">
    <h2>è®¾ç½®</h2>
    <label>
        <span>å®‰é™æ—¶é—´ï¼ˆç§’ï¼‰:</span>
        <input type="number" id="countdownInputSettings" value="30" min="1" />
    </label>
    <label>
        <span>å®‰é™é˜ˆå€¼ï¼ˆåˆ†è´ï¼‰:</span>
        <input type="number" id="dbThresholdInputSettings" value="35" min="1" />
    </label>
    <button onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const saplings = document.querySelectorAll('.sapling');
        const bigTree = document.querySelector('.big-tree');

        setTimeout(() => {
            saplings.forEach((s, index) => {
                s.style.opacity = '1';
                s.style.transform = 'scale(1)';
                s.style.transitionDelay = `${index * 0.2}s`;
            });
        }, 500);

        setTimeout(() => {
            saplings.forEach(s => {
                s.style.opacity = '0';
                s.style.transform = 'scale(0)';
            });
            bigTree.style.opacity = '1';
            bigTree.style.transform = 'scale(1)';
        }, 2000);
    });

    function updateBackground(score) {
        const baseHue = 38;
        const maxHue = 100;
        const baseSaturation = 55;
        const maxSaturation = 70;
        const baseLightness = 88;
        const minLightness = 78;

        const progress = Math.min(score / 10, 10);
        const currentHue = baseHue + (maxHue - baseHue) * Math.pow(progress / 10, 0.9);
        const currentSaturation = baseSaturation + (maxSaturation - baseSaturation) * Math.pow(progress / 10, 0.8);
        const currentLightness = baseLightness - (baseLightness - minLightness) * Math.pow(progress / 10, 1.2);

        document.body.style.backgroundColor = `hsl(${currentHue}, ${currentSaturation}%, ${currentLightness}%)`;
    }

    let audioContext, analyser, microphone, javascriptNode;
    let isQuiet = false;
    let isRunning = false;
    let countdownTimer = null;
    let score = 0;
    let saplingCount = 0;

    const dbDisplay = document.getElementById('decibel');
    const scoreDisplay = document.getElementById('score');
    const countdownDisplay = document.getElementById('countdown');
    const treeGrid = document.getElementById('treeGrid');
    const settingsPanel = document.getElementById('settingsPanel');
    const floatingIcons = document.getElementById('floatingIcons');
    const startPauseButton = document.getElementById('startPauseButton');
    const initialControls = document.getElementById('initialControls');

    function toggleSettings() {
        document.getElementById('countdownInputSettings').value = document.getElementById('countdownInput').value;
        document.getElementById('dbThresholdInputSettings').value = document.getElementById('dbThresholdInput').value;
        settingsPanel.classList.toggle('active');
    }

    function saveSettings() {
        countdownSeconds = parseInt(document.getElementById('countdownInputSettings').value) || 10;
        dbThreshold = parseInt(document.getElementById('dbThresholdInputSettings').value) || 50;
        document.getElementById('countdownInput').value = countdownSeconds;
        document.getElementById('dbThresholdInput').value = dbThreshold;
        settingsPanel.classList.remove('active');
    }

    function resetAndStartChallenge() {
        score = 0;
        saplingCount = 0;
        treeGrid.innerHTML = "";
        scoreDisplay.textContent = score;
        document.body.style.backgroundColor = '#f4e7d3';
        startChallenge();
    }

    function toggleChallenge() {
        isRunning ? pauseChallenge() : startChallenge();
    }

    function startChallenge() {
        countdownSeconds = parseInt(document.getElementById('countdownInput').value) || 10;
        dbThreshold = parseInt(document.getElementById('dbThresholdInput').value) || 50;

        if (isRunning) return;
        isRunning = true;

        initialControls.style.display = 'none';
        floatingIcons.style.display = 'flex';

        startMicrophone();
        startCountdownCycle();

        startPauseButton.textContent = 'â¸ï¸';
        startPauseButton.classList.add('active');
    }

    function pauseChallenge() {
        isRunning = false;
        clearInterval(countdownTimer);
        countdownDisplay.textContent = "--";
        stopMicrophone();

        startPauseButton.textContent = 'ğŸ®';
        startPauseButton.classList.remove('active');
    }

    function startCountdownCycle() {
        if (!isRunning) return;
        remainingTime = countdownSeconds;
        updateCountdownUI();

        clearInterval(countdownTimer);
        countdownTimer = setInterval(() => {
            if (!isRunning) return;

            if (isQuiet) {
                countdownDisplay.textContent = `ç¯å¢ƒå®‰é™ï¼Œä¿æŒä¸­... (${remainingTime}s)`;
            } else {
                countdownDisplay.textContent = `ç¯å¢ƒå¤ªåµï¼Œè¯·ä¿æŒå®‰é™... (${remainingTime}s)`;
                return;
            }

            remainingTime--;
            updateCountdownUI();

            if (remainingTime <= 0) {
                clearInterval(countdownTimer);
                growSapling();
                setTimeout(startCountdownCycle, 1000);
            }
        }, 1000);
    }

    function updateCountdownUI() {
        countdownDisplay.textContent = `${remainingTime} ç§’`;
    }

    function growSapling() {
        const sapling = document.createElement('div');
        sapling.className = 'sapling grow-animation';
        sapling.textContent = 'ğŸŒ±';
        treeGrid.appendChild(sapling);
        saplingCount++;

        if (saplingCount >= 2) {
            const saplings = treeGrid.querySelectorAll('.sapling');
            if (saplings.length >= 2) {
                saplings[0].classList.add('merge-animation');
                saplings[1].classList.add('merge-animation');

                setTimeout(() => {
                    saplings[0].remove();
                    saplings[1].remove();
                    saplingCount -= 2;

                    const tree = document.createElement('div');
                    tree.className = 'tree grow-animation';
                    tree.textContent = 'ğŸŒ³';
                    treeGrid.appendChild(tree);
                    score++;
                    scoreDisplay.textContent = score;

                    if (score % 10 === 0) {
                        updateBackground(score);
                    }
                }, 800);
            }
        }
    }

    function startMicrophone() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

            analyser.smoothingTimeConstant = 0.8;
            analyser.fftSize = 1024;

            microphone.connect(analyser);
            analyser.connect(javascriptNode);
            javascriptNode.connect(audioContext.destination);

            javascriptNode.onaudioprocess = function () {
                const array = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(array);
                const average = array.reduce((a, b) => a + b) / array.length;
                const db = Math.round(average);
                dbDisplay.textContent = db;
                isQuiet = db <= dbThreshold;
            };
        }).catch(err => {
            alert("éº¦å…‹é£å¯åŠ¨å¤±è´¥ï¼š" + err.message);
        });
    }

    function stopMicrophone() {
        if (microphone?.mediaStream) {
            microphone.mediaStream.getTracks().forEach(track => track.stop());
        }
        if (audioContext) {
            audioContext.close();
        }
    }
</script>
</body>
</html>
